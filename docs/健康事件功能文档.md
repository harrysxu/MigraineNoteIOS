# 健康事件功能文档

本文档整合健康事件记录功能的实施说明、使用指南与表单优化内容。

---

## 1. 功能概述

健康事件记录功能让用户记录日常健康管理活动，与偏头痛发作记录分开管理，形成完整治疗画像。支持三类事件：

1. **日常用药**：预防性药物、中成药等
2. **中医治疗**：针灸、推拿按摩、拔罐、刮痧、艾灸等
3. **手术记录**：手术名称、医院、医生

主要能力包括：混合时间轴展示、按类型筛选、用药依从性统计、中医治疗统计、治疗效果前后对比（30 天）、CSV 导出。

---

## 2. 数据模型

### HealthEvent

```swift
// 基础字段
id: UUID, eventDate: Date, eventTypeRawValue: String, notes: String?
createdAt: Date, updatedAt: Date

// 用药事件：medicationLogs (数组)
@Relationship(deleteRule: .cascade) var medicationLogsData: [MedicationLog]?
// 计算属性 medicationLogs 展开；medicationLog 保持向后兼容

// 中医治疗：tcmTreatmentType, tcmDuration (分钟)

// 手术：surgeryName, hospitalName, doctorName
```

- 事件类型：`medication` / `tcmTreatment` / `surgery`
- 用药支持多种药物：`medicationLogs` 数组，`medicationLog` 为兼容单药物的计算属性

### TimelineItem

统一时间轴结构，枚举两种类型：
- `attack(AttackRecord)`：偏头痛发作
- `healthEvent(HealthEvent)`：健康事件

用于在 AttackListView、HomeView 等统一展示并按时间排序。

### 与 MedicationLog 关系

- `MedicationLog` 可关联到：
  - `AttackRecord`（发作期用药）
  - `HealthEvent`（日常用药）
- 用药记录复用 `Medication` 药箱和 `MedicationLog` 模型

---

## 3. 事件类型说明

| 类型 | 字段 | 说明 |
|------|------|------|
| **用药** | medicationLogs | 从药箱选择或手动输入；支持多药；剂量、单位、服用时间 |
| **中医治疗** | tcmTreatmentType, tcmDuration | 类型：针灸/推拿按摩/拔罐/刮痧/艾灸/中药汤剂/其他；时长 5–120 分钟 |
| **手术** | surgeryName, hospitalName, doctorName | 手术名称必填，医院和医生可选 |

---

## 4. UI 界面

### AddHealthEventView

- 顶部 Segmented Picker 选择事件类型（仅 `Text`，避免 HStack+Image 导致点击区域异常）
- 日期时间选择
- 分类型表单：
  - 用药：添加药物按钮 + 已选药物列表 + 删除；Sheet 中 `UnifiedMedicationInputSheet`
  - 中医治疗：类型选择 + 时长滑块
  - 手术：名称、医院、医生输入
- 通用备注

### HealthEventDetailView

按类型展示：事件类型卡片、用药列表、中医类型与时长、手术信息、备注。

### 混合时间轴 (AttackListView)

- 同时查询发作记录和健康事件，按时间排序，按年份分组
- 健康事件行：左侧图标（用药蓝、中医绿、手术蓝）、标题、日期、详情、右箭头

### 筛选

记录类型：全部 / 偏头痛发作 / 健康事件 / 仅用药 / 仅中医治疗 / 仅手术，可配合时间范围和搜索。

---

## 5. 统计分析

### 用药依从性 (AnalyticsEngine)

- 统计天数、用药天数、遗漏天数、依从率
- 依从率颜色：≥80% 绿、≥60% 橙、<60% 红
- 环形进度图展示

### 中医治疗统计

- 总治疗次数、平均治疗时长
- 各治疗类型频次和占比

### 治疗效果关联分析

- 对比治疗开始前 30 天与后 30 天的发作
- 展示发作天数变化、平均疼痛强度变化
- 标注是否有改善

---

## 6. 数据导出

### CSVExporter

1. `exportHealthEvents()`：单独导出健康事件
2. `exportCompleteHealthData()`：完整健康数据

完整导出结构：
- 第一部分：偏头痛发作统计
- 第二部分：健康事件统计（用药依从性、中医治疗）
- 第三部分：偏头痛发作详细记录
- 第四部分：健康事件详细记录

入口：个人 → 数据导出，选择时间范围和 CSV 格式。

---

## 7. 技术要点

### MedicationManaging 协议

统一 `RecordingViewModel` 与 `HealthEventMedicationViewModel` 接口，便于共享 UI：

```swift
protocol MedicationManaging: AnyObject, Observable {
    var selectedMedications: [(medication, customName, dosage, unit, timeTaken)] { get set }
    func addMedication(...)
    func removeMedication(at:)
    func syncMedicationToCabinet(...) -> Medication?
}
```

### UnifiedMedicationInputSheet 泛型

`UnifiedMedicationInputSheet<ViewModel: MedicationManaging>` 同时支持头痛管家和健康事件用药输入，实现 UI 复用。

### Segmented Picker 修复

Picker 内不宜使用 `HStack + Image`，改用纯 `Text(type.rawValue).tag(type)`，保证各选项可正常点击。

### 多药物支持与兼容

- `HealthEvent.medicationLogs` 为数组
- 保留 `medicationLog` 计算属性以保证向后兼容

---

## 8. 使用指南

### 记录流程

1. 首页 →「记录健康事件」
2. 选择事件类型（用药/中医治疗/手术）
3. 用药：从药箱选择或手动输入；支持多药；可同步新药到药箱
4. 中医治疗：选择类型、设置 5–120 分钟时长
5. 手术：填写手术名称、医院、医生
6. 保存

### 查看记录

- 记录页：默认混合时间轴，可用筛选器按类型查看
- 点击进入详情
- 左滑删除

### 统计查看

- 数据 → 图表，向下滚动
- 用药依从性、中医治疗统计、治疗效果分析

### 常见问题

**Q: 健康事件与头痛管家的区别？**
- 头痛管家：发作时的情况（疼痛、症状、诱因、发作期用药）
- 健康事件：日常管理（预防用药、中医调理、手术）

**Q: 发作时用药 vs 日常用药？**
- 发作时用药 → 头痛管家中添加
- 日常预防性用药 → 健康事件中记录

**Q: 如何评估治疗效果？**
- 在「治疗效果分析」中查看治疗前后 30 天的发作天数和疼痛强度变化。

### 使用场景示例

| 场景 | 操作要点 |
|------|----------|
| 每日预防性用药 | 每天固定时间记录；从药箱选择药物；可在备注写「睡前服用」等 |
| 每周针灸/按摩 | 治疗结束后记录；选择类型、设置时长；备注可写穴位或部位 |
| 手术记录 | 填写手术名称、医院、医生；备注记录效果或注意事项 |
| 就医前准备 | 导出完整 CSV，包含发作+健康事件，便于医生全面了解 |

### 注意事项

- **数据迁移**：新增 `HealthEvent` 或修改 `medicationLogs` 后，首次运行建议删除应用重装或清除数据
- **CloudKit**：`HealthEvent` 已纳入 Schema，支持 iCloud 同步
- **隐私**：导出 CSV 含健康隐私，分享时注意保护

---

## 9. 相关文件清单

| 类别 | 文件 |
|------|------|
| Models | `HealthEvent.swift`, `TimelineItem.swift` |
| Views | `AddHealthEventView.swift`, `HealthEventDetailView.swift` |
| ViewModels | `HealthEventMedicationViewModel.swift` |
| Protocols | `MedicationManaging.swift` |
| 使用场景 | `HomeView.swift`（入口）, `AttackListView.swift`（时间轴）, `HealthEventRowView` |
| 分析 | `AnalyticsEngine.swift`, `AnalyticsView.swift` |
| 导出 | `CSVExporter.swift`, `DataExportView.swift` |
| 配置 | `migraine_noteApp.swift`（ModelContainer 注册 HealthEvent） |
| 测试 | `HealthEventTestData.swift`, `HealthEventTests.swift`, `HealthEventMedicationViewModelTests.swift` |

---

*更新日期：2026 年 2 月*
