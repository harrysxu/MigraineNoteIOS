# 自定义标签长度限制实施说明

## 概述
为了保证用户界面的整洁性和数据的一致性,为所有自定义标签添加了长度限制功能。

## 功能特点

### 1. 标签长度限制
- **最小长度**: 1个字符
- **最大长度**: 10个字符
- 适用于所有类型的标签:
  - 症状标签(西医/中医)
  - 诱因标签(所有分类)

### 2. 实时字符计数
- 在输入框下方显示当前字符数/最大字符数
- 达到上限时,计数器颜色变为橙色警告色
- 自动截断超出长度的输入

### 3. 多层验证
- **前端验证**: 
  - 输入时实时限制长度
  - 提交前检查长度范围
- **后端验证**:
  - `LabelManager.addCustomLabel()` 添加标签时验证
  - `LabelManager.renameLabel()` 重命名标签时验证

## 技术实现

### 更新的文件

#### 1. AddCustomLabelChip.swift
添加记录时快速自定义标签的组件。

**更新内容**:
- 添加 `maxLabelLength` 和 `minLabelLength` 常量
- 输入框添加 `onChange` 监听,自动截断超长输入
- 添加字符计数显示 `"X/10"`
- 更新说明文字,显示长度限制
- 增强错误处理,支持新的错误类型

**关键代码**:
```swift
private let maxLabelLength = 10
private let minLabelLength = 1

TextField("标签名称", text: $labelName)
    .onChange(of: labelName) { _, newValue in
        if newValue.count > maxLabelLength {
            labelName = String(newValue.prefix(maxLabelLength))
        }
        errorMessage = nil
    }

Text("\(labelName.count)/\(maxLabelLength)")
    .foregroundStyle(
        labelName.count >= maxLabelLength
            ? Color.statusWarning
            : Color.textSecondary
    )
```

#### 2. LabelManager.swift
标签管理服务。

**更新内容**:
- `addCustomLabel()` 方法添加长度验证
- `renameLabel()` 方法添加长度验证
- 新增错误类型: `invalidName` 和 `nameTooLong`

**关键代码**:
```swift
// 验证标签名称长度
let trimmedName = displayName.trimmingCharacters(in: .whitespaces)
guard !trimmedName.isEmpty else {
    throw LabelError.invalidName
}

guard trimmedName.count <= 10 else {
    throw LabelError.nameTooLong
}
```

#### 3. SymptomLabelEditor.swift
症状标签管理编辑器。

**更新内容**:
- `AddSymptomLabelSheet` 添加长度限制常量
- 输入框添加字符计数显示
- 更新说明文字

#### 4. TriggerLabelEditor.swift
诱因标签管理编辑器。

**更新内容**:
- `AddTriggerLabelSheet` 添加长度限制常量
- 输入框添加字符计数显示
- 更新说明文字

#### 5. LabelRow.swift
标签行组件(用于标签列表)。

**更新内容**:
- 重命名 Alert 提示信息添加长度限制说明
- 重命名确认时验证长度

## 用户体验优化

### 1. 清晰的提示
- 在输入框说明中明确标注"(1-10个字符)"
- 实时显示字符计数,让用户清楚剩余可输入字符数

### 2. 自动截断
- 输入超过10个字符时自动截断
- 避免用户输入过长内容后被拒绝的挫败感

### 3. 视觉反馈
- 字符数达到上限时,计数器变为橙色
- 提供即时的视觉警告

### 4. 友好的错误提示
错误类型对应的提示信息:
- `invalidName`: "标签名称无效"
- `nameTooLong`: "标签名称过长,最多10个字符"
- `duplicateName`: "该标签已存在"

## 数据同步机制

### 自动持久化
自定义标签通过 SwiftData 自动持久化存储:

1. **数据模型**: `CustomLabelConfig`
   - 使用 `@Model` 宏标记
   - SwiftData 自动管理数据库操作

2. **查询机制**: 使用 `@Query` 宏
   ```swift
   @Query(filter: #Predicate<CustomLabelConfig> { 
       $0.category == "symptom" && $0.isHidden == false 
   }, sort: \CustomLabelConfig.sortOrder)
   private var symptomLabels: [CustomLabelConfig]
   ```

3. **跨视图同步**:
   - 所有视图共享同一个 `ModelContext`
   - 在任何位置添加的自定义标签立即在所有视图可见
   - 应用重启后标签依然保留

### 同步流程示例

**添加自定义标签**:
1. 用户在记录页面点击"自定义"按钮
2. 输入标签名称(受长度限制)
3. 点击"添加"
4. `LabelManager.addCustomLabel()` 验证并保存到数据库
5. SwiftData 触发 `@Query` 更新
6. 所有相关视图自动刷新,显示新标签

**标签可见性**:
- 记录页面: 只显示未隐藏的标签
- 设置页面: 显示所有标签(包括隐藏的)

## 测试建议

### 功能测试
1. **长度验证测试**:
   - ✅ 输入1个字符,能正常保存
   - ✅ 输入10个字符,能正常保存
   - ✅ 尝试输入11个字符,自动截断为10个字符
   - ✅ 输入空格或空内容,显示错误提示

2. **字符计数测试**:
   - ✅ 字符计数实时更新
   - ✅ 达到10个字符时计数器变为橙色
   - ✅ 删除字符时计数器颜色恢复正常

3. **重命名测试**:
   - ✅ 重命名自定义标签时也受长度限制
   - ✅ Alert 提示显示长度限制信息

4. **同步测试**:
   - ✅ 在记录页面添加自定义标签
   - ✅ 在设置页面能看到新标签
   - ✅ 重启应用后标签依然存在

### 边界情况测试
1. 中文字符(每个中文字符算1个字符)
2. 英文字符和数字
3. 特殊字符和 emoji
4. 混合输入(中英文混合)

## 相关常量

在代码中定义的长度限制常量:

```swift
private let maxLabelLength = 10  // 最大长度
private let minLabelLength = 1   // 最小长度
```

如需调整长度限制,只需修改这些常量值。建议保持一致性,在所有相关组件中使用相同的值。

## 注意事项

1. **默认标签不受影响**:
   - 默认标签的长度不受此限制影响
   - 只有用户自定义的标签才会被验证

2. **已存在的长标签**:
   - 如果数据库中已有超过10个字符的标签(在实施此限制前创建的)
   - 这些标签会继续正常工作
   - 但不能重命名为超过10个字符的名称

3. **国际化考虑**:
   - 当前长度限制基于字符数,不区分中英文
   - 一个中文字符 = 一个英文字符
   - 如需按字节数限制,需修改验证逻辑

## 后续改进建议

1. **可配置的长度限制**:
   - 将长度限制值保存到用户设置中
   - 允许用户自定义长度限制(在合理范围内)

2. **更丰富的验证**:
   - 禁止某些特殊字符
   - 检查是否包含敏感词
   - 自动去除前后空格

3. **批量操作**:
   - 支持批量导入自定义标签
   - 导入时自动验证长度
   - 提供验证失败的详细报告

---

**更新日期**: 2026年2月3日  
**版本**: v1.0  
**相关文档**: 
- UI_UX设计文档.md
- 新增文件清单.md
