# 自定义标签功能实施说明

## 概述

为疼痛性质、伴随症状、中医症状、诱因分析、非药物干预等模块添加了自定义标签功能，用户可以添加自定义选项，并自动同步到标签管理页面。

## 实施内容

### 1. 扩展标签系统

#### 1.1 新增标签类别

在 `CustomLabelConfig.swift` 中扩展了 `LabelCategory` 枚举：

- `painQuality` - 疼痛性质
- `intervention` - 非药物干预

#### 1.2 初始化默认标签

在 `LabelManager.swift` 中新增：

- `initializePainQualityLabels()` - 初始化默认疼痛性质标签
  - 搏动性、压迫感、刺痛、钝痛、胀痛

- `initializeInterventionLabels()` - 初始化默认非药物干预标签
  - 睡眠、冷敷、热敷、按摩、针灸、暗室休息、深呼吸、冥想

### 2. 更新记录界面

#### 2.1 Step2_PainAssessmentView（疼痛性质）

**修改内容：**
- 添加了 `@Query` 查询疼痛性质标签
- 使用 `selectedPainQualityNames` 存储选中的标签名称
- 添加 `AddCustomLabelChip` 组件，支持自定义疼痛性质

#### 2.2 Step5_InterventionsView（非药物干预）

**修改内容：**
- 添加了 `@Query` 查询非药物干预标签
- 移除硬编码的 `nonPharmacologicalOptions` 列表
- 添加 `AddCustomLabelChip` 组件，支持自定义干预方式

### 3. 更新 RecordingViewModel

**新增属性：**
- `selectedPainQualityNames: Set<String>` - 存储选中的疼痛性质标签名称

**修改方法：**
- `loadExistingAttack()` - 加载疼痛性质名称
- `saveRecording()` - 保存疼痛性质名称
- `resetTemporaryData()` - 重置疼痛性质名称

### 4. 标签管理界面

#### 4.1 新增编辑器视图

创建了两个新的编辑器视图：

**PainQualityLabelEditor.swift**
- 疼痛性质标签管理界面
- 支持显示/隐藏、重命名、删除、排序

**InterventionLabelEditor.swift**
- 非药物干预标签管理界面
- 支持显示/隐藏、重命名、删除、排序

#### 4.2 通用添加标签表单

**AddLabelSheet.swift**
- 通用的添加标签表单组件
- 支持所有标签类别
- 包含输入验证和错误处理

#### 4.3 更新 LabelManagementView

在标签管理主界面中添加了两个新的 Tab：
- 疼痛性质
- 非药物干预

## 新增文件清单

以下文件需要添加到 Xcode 项目中：

1. `/migraine_note/Views/Settings/LabelManagement/PainQualityLabelEditor.swift`
2. `/migraine_note/Views/Settings/LabelManagement/InterventionLabelEditor.swift`
3. `/migraine_note/Views/Settings/LabelManagement/AddLabelSheet.swift`

## 使用说明

### 用户如何使用

1. **在记录界面添加自定义标签：**
   - 在疼痛性质、伴随症状、中医症状、诱因分析、非药物干预等区域
   - 点击"自定义"按钮
   - 输入标签名称（1-10个字符）
   - 点击"添加"
   - 自定义标签自动添加到当前记录，并同步到标签管理

2. **在标签管理中管理标签：**
   - 进入"设置" > "标签管理"
   - 选择对应的标签类别（症状、诱因、疼痛性质、非药物干预）
   - 可以进行以下操作：
     - 显示/隐藏标签（点击眼睛图标）
     - 重命名自定义标签
     - 删除自定义标签
     - 拖动调整标签顺序
     - 添加新的自定义标签

### 标签规则

- **默认标签**：只能隐藏，不能删除或重命名
- **自定义标签**：可以重命名、删除、隐藏
- **字符限制**：标签名称1-10个字符
- **重复检测**：不允许添加重复的标签名称

## 技术细节

### 数据流

```
用户添加自定义标签
    ↓
AddCustomLabelChip
    ↓
LabelManager.addCustomLabel()
    ↓
保存到 CustomLabelConfig (SwiftData)
    ↓
@Query 自动刷新界面
    ↓
记录界面显示新标签
标签管理界面显示新标签
```

### 数据存储

所有标签存储在 `CustomLabelConfig` 模型中：
- `category`: 标签类别（symptom, trigger, painQuality, intervention）
- `subcategory`: 子分类（可选）
- `displayName`: 显示名称
- `isDefault`: 是否为默认标签
- `isHidden`: 是否隐藏
- `sortOrder`: 排序顺序

### 查询方式

使用 SwiftData 的 `@Query` 宏进行实时查询：

```swift
@Query(filter: #Predicate<CustomLabelConfig> { 
    $0.category == "painQuality" && $0.isHidden == false 
}, sort: \CustomLabelConfig.sortOrder)
private var painQualityLabels: [CustomLabelConfig]
```

## 注意事项

1. **首次运行**：默认标签会在应用首次启动时自动初始化
2. **数据迁移**：如果是从旧版本升级，需要确保 `LabelManager.initializeDefaultLabelsIfNeeded()` 被调用
3. **CloudKit 同步**：自定义标签会自动同步到 iCloud（如果启用）

## 下一步优化建议

1. 添加标签使用频率统计
2. 支持标签导入/导出
3. 添加标签搜索功能
4. 支持标签颜色自定义
5. 添加常用标签快捷入口

## 测试检查点

- [ ] 在疼痛性质区域添加自定义标签
- [ ] 在非药物干预区域添加自定义标签
- [ ] 在症状区域添加自定义标签（已存在）
- [ ] 在诱因区域添加自定义标签（已存在）
- [ ] 在标签管理中查看所有标签
- [ ] 隐藏/显示标签
- [ ] 重命名自定义标签
- [ ] 删除自定义标签
- [ ] 调整标签排序
- [ ] 验证标签名称长度限制
- [ ] 验证重复标签检测
- [ ] 保存记录后标签数据正确
- [ ] 编辑记录时标签数据加载正确
