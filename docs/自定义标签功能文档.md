# 自定义标签功能文档

## 功能概述

为疼痛性质、伴随症状、中医症状、诱因分析、非药物干预等模块添加了自定义标签功能，用户可以在记录界面或标签管理页面添加自定义选项。

## 标签类别

| 类别 | category 值 | 说明 |
|------|------------|------|
| 症状（西医） | `symptom` (subcategory: `western`) | 恶心、呕吐等 |
| 症状（中医） | `symptom` (subcategory: `tcm`) | 气滞、血瘀等 |
| 诱因 | `trigger` (subcategory: 各 TriggerCategory) | 食物、环境、睡眠等 |
| 疼痛性质 | `painQuality` | 搏动性、压迫感、刺痛等 |
| 非药物干预 | `intervention` | 睡眠、冷敷、热敷、针灸等 |
| 先兆类型 | `aura` | 视觉先兆、感觉先兆等 |

## 数据模型

所有标签存储在 `CustomLabelConfig` 模型中：

```swift
@Model
class CustomLabelConfig {
    var category: String      // 标签类别
    var subcategory: String?  // 子分类（可选）
    var displayName: String   // 显示名称
    var isDefault: Bool       // 是否为默认标签
    var isHidden: Bool        // 是否隐藏
    var sortOrder: Int        // 排序顺序
}
```

## 标签规则

- **默认标签**：只能隐藏，不能删除或重命名
- **自定义标签**：可以重命名、删除、隐藏
- **字符限制**：标签名称 1-10 个字符（中英文均按 1 个字符计）
- **重复检测**：不允许添加重复的标签名称

## 长度限制实现

### 前端验证
- 输入时实时限制长度，超过 10 字符自动截断
- 实时字符计数显示（"X/10"），达到上限时变为橙色
- 提交前检查长度范围

### 后端验证
- `LabelManager.addCustomLabel()` 添加时验证
- `LabelManager.renameLabel()` 重命名时验证
- 错误类型：`invalidName`（空）、`nameTooLong`（>10）、`duplicateName`（重复）

```swift
private let maxLabelLength = 10
private let minLabelLength = 1

// 自动截断
TextField("标签名称", text: $labelName)
    .onChange(of: labelName) { _, newValue in
        if newValue.count > maxLabelLength {
            labelName = String(newValue.prefix(maxLabelLength))
        }
    }
```

## 数据流

```
用户添加自定义标签
    ↓
AddCustomLabelChip 组件
    ↓
LabelManager.addCustomLabel()（验证 + 保存）
    ↓
保存到 CustomLabelConfig (SwiftData)
    ↓
@Query 自动刷新界面
    ↓
记录界面和标签管理界面同步显示新标签
```

## 查询方式

使用 SwiftData 的 `@Query` 宏进行实时查询：

```swift
@Query(filter: #Predicate<CustomLabelConfig> { 
    $0.category == "painQuality" && $0.isHidden == false 
}, sort: \CustomLabelConfig.sortOrder)
private var painQualityLabels: [CustomLabelConfig]
```

## 用户使用说明

### 在记录界面添加
1. 在疼痛性质、症状、诱因、非药物干预等区域找到"自定义"按钮
2. 输入标签名称（1-10 个字符）
3. 点击"添加"，标签自动添加到当前记录并同步到标签管理

### 在标签管理中管理
进入"设置" → "标签管理"，选择对应类别：
- **显示/隐藏**：点击眼睛图标
- **重命名**：仅自定义标签可重命名
- **删除**：仅自定义标签可删除
- **排序**：拖动调整顺序
- **添加**：添加新的自定义标签

## 标签管理界面

标签管理主界面（`LabelManagementView`）按类别分 Tab：
- 症状（西医/中医）
- 诱因（按分类）
- 疼痛性质
- 非药物干预
- 先兆类型

每个类别有独立的编辑器视图：
- `SymptomLabelEditor` / `AuraLabelEditor`
- `TriggerLabelEditor`
- `PainQualityLabelEditor`
- `InterventionLabelEditor`

通用组件：
- `AddLabelSheet` - 通用添加标签表单
- `LabelRow` - 标签行组件（支持隐藏/重命名/删除）
- `AddCustomLabelChip` - 记录界面快速添加组件

## 初始化

默认标签在应用首次启动时由 `LabelManager.initializeDefaultLabelsIfNeeded()` 自动初始化，包括：
- 疼痛性质：搏动性、压迫感、刺痛、钝痛、胀痛
- 非药物干预：睡眠、冷敷、热敷、按摩、针灸、暗室休息、深呼吸、冥想
- 症状、诱因、先兆等各自的默认标签

## 注意事项

1. **CloudKit 同步**：自定义标签会自动同步到 iCloud（如果启用）
2. **已有长标签**：限制实施前创建的超长标签可继续使用，但不能重命名为超过 10 字符
3. **数据迁移**：从旧版本升级时需确保 `initializeDefaultLabelsIfNeeded()` 被调用

## 相关文件

- `Models/CustomLabelConfig.swift` - 标签数据模型
- `Services/LabelManager.swift` - 标签管理服务
- `DesignSystem/Components/AddCustomLabelChip.swift` - 快速添加组件
- `Views/Settings/LabelManagement/` - 标签管理界面（LabelManagementView、各编辑器、AddLabelSheet、LabelRow）
