# 天气功能文档

## 1. 功能概述

头痛管家应用集成天气追踪功能，帮助用户了解环境因素（特别是气压变化）与偏头痛发作的关系。

**核心能力**：
- 保存记录时自动获取并关联当时天气数据
- 首页实时展示当前天气与风险提示
- 记录详情页展示发作时的完整天气状况
- 自动识别可能触发偏头痛的天气条件并给出提示

**技术依赖**：iOS 17.0+、WeatherKit、CoreLocation；需网络连接，建议真机测试（模拟器可能不可用）。

---

## 2. 技术架构

### 技术栈
- **WeatherKit**：Apple 官方天气服务 API
- **CoreLocation**：获取用户位置；使用千米级精度（`kCLLocationAccuracyKilometer`）节省电量
- **Info.plist**：已配置 `NSLocationWhenInUseUsageDescription`（使用期间允许访问位置）

### 数据模型 WeatherSnapshot
- **气压** (pressure)：hPa
- **气压趋势** (pressureTrend)：上升 / 下降 / 稳定（基于未来 3 小时预测）
- **温度** (temperature)：°C
- **湿度** (humidity)：百分比
- **风速** (windSpeed)
- **天气状况** (condition)：晴 / 云 / 雨等
- **位置** (location)：城市名称（反向地理编码）

### 数据流
```
用户创建/编辑记录
    ↓
RecordingViewModel.saveRecording()
    ↓
WeatherManager.fetchCurrentWeather()
    ↓
创建 WeatherSnapshot 并关联到 AttackRecord
    ↓
保存到 SwiftData（可同步到 iCloud）
```

### 架构示意
```
HomeView / SimplifiedRecordingView
    ↓
HomeViewModel / RecordingViewModel
    ↓
WeatherManager（WeatherKit + CoreLocation + 缓存）
    ↓
WeatherSnapshot
```

---

## 3. 缓存机制

### 策略
- **位置**：WeatherManager 内存缓存
- **时长**：30 分钟
- **键**：当前位置 + 时间戳

### API
```swift
func fetchCurrentWeather(forceRefresh: Bool = false) async throws -> WeatherSnapshot
func clearCache()
var isCacheValid: Bool
var cacheRemainingTime: TimeInterval?
```

### 流程
```
请求天气 → 缓存有效? → 是 → 返回缓存
                    → 否 → 调用 WeatherKit API → 更新缓存 → 返回
```

### 性能
| 场景     | 耗时      |
|----------|-----------|
| 缓存命中 | < 10ms    |
| API 调用 | 1–3 秒    |
| API 调用减少 | 约 80% |

---

## 4. UI 展示

### 首页天气卡片 (WeatherInsightCard)
- 温度、位置、天气图标
- 气压（含趋势 ↑/↓/—）、湿度
- 风险提示（气压骤降、高湿度、极端温度）
- **刷新按钮**：右上角，点击强制刷新；刷新中带旋转动画且不可重复点击

### 记录详情页 (AttackDetailView)
- **WeatherDetailBox**：统一天气展示
- 48pt 大字号温度
- 城市、记录时间
- 4 个数据格：气压、湿度、风速、风险等级
- 风险警告卡片（存在时单独展示）

### 加载状态
- 加载中：进度条
- 成功：完整天气信息
- 失败：错误提示（获取失败不影响记录保存）

---

## 5. 风险识别规则

| 条件               | 提示文案                       |
|--------------------|--------------------------------|
| 气压 < 1010 hPa 且下降 | 气压骤降，可能触发头痛         |
| 湿度 > 80%         | 高湿度环境，注意防湿           |
| 温度 > 35°C        | 高温天气，注意防暑             |
| 温度 < 0°C         | 气温过低，注意保暖             |

---

## 6. 用户使用指南

### 权限设置
1. 首次打开应用时授权位置（"允许一次"或"使用App时允许"）
2. 修改路径：设置 → 隐私与安全性 → 定位服务 → 头痛管家 → 选择「使用App时」

### 创建记录
1. 点击「开始记录」
2. 填写疼痛强度、部位等
3. 点击「完成记录」→ 天气自动关联，无需手动操作

### 查看历史
- 在记录详情页查看发作时的天气、气压、湿度及风险因素
- 编辑旧记录（10 天内）会尝试补全天气数据

### 常见问题

**Q: 首页没有天气？**  
可能原因：未授权位置、无网络、定位关闭。可检查设置并点击刷新。

**Q: 多久更新？**  
首页：打开时更新，可点击刷新；记录：创建/编辑时获取当时天气。

**Q: 历史天气？**  
WeatherKit 支持最近 10 天；10 天以前的记录无法补充天气。

**Q: 国外可用？**  
支持全球范围，根据位置自动获取当地天气。

**Q: 流量？**  
单次约 1–2 KB，有 30 分钟缓存，正常使用流量很少。

**Q: 天气获取失败？**  
不影响记录保存；记录正常保存，但可能无天气字段。

---

## 7. 隐私说明

- **定位方式**：仅在使用 App 时获取，不在后台追踪
- **使用目的**：仅用于天气服务，不存储精确坐标
- **存储内容**：仅城市名称（如「北京」）
- **数据归属**：存储在用户 iCloud 私有库，开发者无法访问
- **撤销**：可在系统设置中关闭定位；关闭后仅天气功能不可用，其余功能正常

---

## 8. 相关文件

| 文件 | 说明 |
|------|------|
| `Services/WeatherManager.swift` | 天气服务、WeatherKit 调用、CoreLocation、30 分钟缓存 |
| `Models/WeatherSnapshot.swift` | 天气数据模型与风险规则 |
| `Views/Home/HomeView.swift` | 首页、WeatherInsightCard、刷新按钮 |
| `ViewModels/HomeViewModel.swift` | 天气加载、刷新、状态管理 |
| `Views/AttackList/AttackDetailView.swift` | 记录详情、WeatherDetailBox、weatherCard |
| `ViewModels/RecordingViewModel.swift` | 保存记录时集成天气获取 |

**其他**：`SimplifiedRecordingView` 传递 `weatherManager`；`Info.plist` 配置定位权限说明。
