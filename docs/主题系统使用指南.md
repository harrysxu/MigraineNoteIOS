# 主题系统使用指南

## 概述

应用现已支持**亮模式**、**暗模式**和**跟随系统模式**三种主题切换方式。主题系统基于 iOS 系统颜色构建,可自动适配不同模式下的界面显示。

## 新增功能

### 1. 三种主题模式

- **跟随系统** 🌗 - 自动跟随 iOS 系统设置,根据系统时间或用户手动设置切换
- **浅色模式** ☀️ - 始终使用浅色主题,适合白天使用
- **深色模式** 🌙 - 始终使用深色主题,适合暗光环境,保护眼睛

### 2. 主题切换入口

- 打开应用 → **设置** → **外观** → **主题设置**
- 可实时预览不同主题下的界面效果
- 切换主题时带有平滑的过渡动画

## 技术实现

### 1. 颜色系统重构

**文件**: `DesignSystem/Colors.swift`

所有颜色都已改用 iOS 系统颜色,自动适配暗模式/亮模式:

```swift
// ✅ 新的系统颜色定义
static let backgroundPrimary = Color(uiColor: .systemBackground)
static let textPrimary = Color(uiColor: .label)
static let primary = Color(uiColor: .systemBlue)

// ❌ 旧的硬编码颜色(已移除)
// static let backgroundPrimary = Color.black
// static let textPrimary = Color(white: 0.92)
```

**主要颜色映射**:

| 颜色名称 | 浅色模式 | 深色模式 |
|---------|---------|---------|
| `backgroundPrimary` | 白色 (#FFFFFF) | 黑色 (#000000) |
| `backgroundSecondary` | #F2F2F7 | #1C1C1E |
| `backgroundTertiary` | #FFFFFF | #2C2C2E |
| `textPrimary` | 黑色 | 白色 |
| `textSecondary` | #3C3C43 99% | #EBEBF5 60% |
| `textTertiary` | #3C3C43 48% | #EBEBF5 30% |
| `divider` | #3C3C43 36% | #545458 65% |

### 2. 主题管理器

**文件**: `DesignSystem/ThemeManager.swift`

```swift
/// 主题管理器 - 使用 @Observable 宏
@Observable
class ThemeManager {
    var currentTheme: AppTheme  // 当前主题
    
    func setTheme(_ theme: AppTheme)  // 切换主题
}

/// 主题枚举
enum AppTheme: String {
    case system = "跟随系统"
    case light = "浅色模式"
    case dark = "深色模式"
}
```

### 3. 应用级集成

**文件**: `migraine_noteApp.swift`

```swift
@main
struct migraine_noteApp: App {
    @State private var themeManager = ThemeManager()
    
    var body: some Scene {
        WindowGroup {
            MainTabView()
                .environment(themeManager)  // 注入环境
                .applyAppTheme(themeManager.currentTheme)  // 应用主题
        }
    }
}
```

### 4. 设置页面

**文件**: `Views/Settings/SettingsView.swift`

添加了**外观**分组,包含主题设置入口。

**文件**: `Views/Settings/ThemeSettingsView.swift`

专门的主题设置页面,提供:
- 三种主题模式的选择列表
- 实时主题预览区域
- 主题说明和使用建议

## 如何使用

### 用户操作

1. 打开应用
2. 点击底部 **设置** 标签
3. 点击 **主题设置**
4. 选择喜欢的主题模式:
   - **跟随系统** - 推荐,自动适应环境
   - **浅色模式** - 白天户外使用
   - **深色模式** - 夜间或暗光环境

### 开发者使用

在新的视图中使用颜色:

```swift
// ✅ 正确做法 - 使用系统颜色
Text("标题")
    .foregroundColor(AppColors.textPrimary)  // 自动适配

VStack {
    // 内容
}
.background(AppColors.backgroundSecondary)  // 自动适配

// ✅ 语义色
Text("成功")
    .foregroundColor(AppColors.success)  // 绿色,自动适配

// ❌ 错误做法 - 不要硬编码颜色
Text("标题")
    .foregroundColor(Color(white: 0.92))  // 不会适配
```

获取当前主题:

```swift
struct MyView: View {
    @Environment(ThemeManager.self) private var themeManager
    
    var body: some View {
        Text("当前主题: \(themeManager.currentTheme.rawValue)")
    }
}
```

## 设计原则

1. **100% 使用系统颜色** - 确保完美适配暗模式/亮模式
2. **避免硬编码颜色** - 不要使用 `Color(white:)` 或 `Color(hex:)`
3. **语义化命名** - 使用 `textPrimary` 而不是 `white` 或 `black`
4. **测试两种模式** - 开发时切换主题测试界面效果

## 迁移指南

### 旧代码迁移

如果代码中使用了旧的颜色定义,需要更新:

```swift
// ❌ 旧代码
.foregroundColor(.white)
.background(Color.black)

// ✅ 新代码
.foregroundColor(AppColors.textPrimary)
.background(AppColors.backgroundPrimary)
```

### 疼痛强度色阶

疼痛强度色阶已改用单色渐变,避免色盲问题:

```swift
// 使用主色调的透明度渐变
Color.painIntensityColor(for: 5)  // 返回 50% 透明度的主色调

// 语义化分类颜色(轻/中/重度)
Color.painCategoryColor(for: 7)  // 返回红色(重度)
```

## 测试

### 测试主题切换

1. **模拟器测试**:
   - 设置 > 开发者 > 外观 > 浅色/深色
   - 观察界面是否正确切换

2. **真机测试**:
   - 设置 > 显示与亮度 > 外观 > 浅色/深色/自动
   - 测试应用内主题切换是否生效

3. **代码测试**:
   ```swift
   #Preview("浅色模式") {
       MyView()
           .preferredColorScheme(.light)
   }
   
   #Preview("深色模式") {
       MyView()
           .preferredColorScheme(.dark)
   }
   ```

## 注意事项

1. **持久化存储** - 用户的主题偏好保存在 `UserDefaults`,应用重启后保持
2. **实时生效** - 切换主题后立即应用到所有界面,无需重启
3. **动画过渡** - 切换时有 0.3 秒的平滑过渡动画
4. **触觉反馈** - 点击主题选项时有轻微触觉反馈

## 特殊颜色

某些情感化设计的颜色保留用于特殊场景:

```swift
// 温暖色调(用于正向鼓励场景)
Color.warmAccent      // 温暖橙 #F4A261
Color.gentlePink      // 柔和粉 #E8A0BF
Color.accentPrimary   // 治愈蓝绿 #5EC4B6
Color.accentSecondary // 柔和蓝 #4A90E2
```

这些颜色不会自动适配暗模式,请谨慎使用。

## 未来优化

- [ ] 支持自定义主题色
- [ ] 支持时间段自动切换(如晚上8点自动切换到暗模式)
- [ ] 支持更多主题变体(高对比度模式等)

## 相关文件

- `DesignSystem/Colors.swift` - 颜色系统定义
- `DesignSystem/ThemeManager.swift` - 主题管理器
- `DesignSystem/Spacing.swift` - 间距系统
- `Views/Settings/ThemeSettingsView.swift` - 主题设置页面
- `migraine_noteApp.swift` - 应用入口
- `docs/极简专业UI_UX设计方案.md` - 设计文档

---

**文档版本**: 1.0  
**更新日期**: 2026年2月3日  
**作者**: AI Assistant
